<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>پنل مدیریت - Took Gallery</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #ff3b8d;
            --primary-light: #ff6bac;
            --dark: #333;
            --light: #fff;
            --border: #ffd6e8;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #FF9800;
            --info: #2196F3;
            --gray: #666;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* مدیریت دسترسی */
        .access-denied {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
            padding: 20px;
        }
        
        .access-denied.active {
            display: flex;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }
        
        .admin-container.active {
            display: block;
        }
        
        /* هدر */
        .admin-header {
            background: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .admin-header h1 {
            color: var(--primary);
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 5px 15px rgba(255, 59, 141, 0.2);
            transition: transform 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* تب‌ها */
        .tabs-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid var(--border);
            padding: 5px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 18px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: var(--gray);
            border-radius: 12px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-btn:hover {
            background: rgba(255, 59, 141, 0.1);
        }
        
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* جدول سفارشات */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .orders-table th {
            background: #f8f9fa;
            padding: 20px 15px;
            text-align: right;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            font-size: 15px;
        }
        
        .orders-table td {
            padding: 20px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .orders-table tr:hover {
            background: #fafafa;
        }
        
        .order-id {
            color: var(--primary);
            font-weight: bold;
            font-size: 14px;
        }
        
        .customer-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .customer-phone {
            color: var(--gray);
            font-size: 13px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-pending { background: #FFF3E0; color: #FF9800; }
        .status-paid { background: #E8F5E9; color: #4CAF50; }
        .status-shipping { background: #E3F2FD; color: #2196F3; }
        .status-delivered { background: #F1F8E9; color: #8BC34A; }
        .status-cancelled { background: #FFEBEE; color: #f44336; }
        
        /* تیکت‌های پشتیبانی */
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .ticket-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .ticket-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--border);
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .ticket-preview {
            color: var(--gray);
            line-height: 1.7;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        /* مودال چت */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .chat-modal.active {
            display: flex;
        }
        
        .chat-window {
            background: white;
            width: 100%;
            max-width: 900px;
            height: 85vh;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        .chat-header {
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-body {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            max-width: 75%;
            padding: 18px;
            border-radius: 18px;
            margin-bottom: 20px;
            position: relative;
            animation: slideIn 0.3s ease;
        }
        
        .user-message {
            background: white;
            margin-right: auto;
            margin-left: 30px;
            border-bottom-left-radius: 5px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
        }
        
        .admin-message {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            margin-left: auto;
            margin-right: 30px;
            border-bottom-right-radius: 5px;
        }
        
        .message-time {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
            text-align: left;
        }
        
        .admin-message .message-time {
            color: rgba(255,255,255,0.8);
        }
        
        .chat-input {
            padding: 25px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
            background: white;
        }
        
        .chat-input textarea {
            flex: 1;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            resize: none;
            min-height: 70px;
            transition: all 0.3s;
        }
        
        .chat-input textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 59, 141, 0.1);
        }
        
        /* دکمه‌های عملیات */
        .admin-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: white;
            border: 2px solid var(--border);
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .refresh-btn {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .logout-btn {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .test-btn {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        /* اعلان‌ها */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 18px 28px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 3000;
            display: none;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease;
        }
        
        .notification.active {
            display: flex;
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--info);
        }
        
        /* ریسپانسیو */
        @media (max-width: 1200px) {
            .tickets-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }
        
        @media (max-width: 992px) {
            .admin-header {
                flex-direction: column;
                text-align: center;
            }
            
            .admin-stats {
                justify-content: center;
            }
            
            .tabs-header {
                flex-direction: column;
            }
            
            .tickets-grid {
                grid-template-columns: 1fr;
            }
            
            .orders-table {
                display: block;
                overflow-x: auto;
            }
            
            .chat-window {
                height: 90vh;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .admin-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .message {
                max-width: 90%;
            }
        }
        
        /* انیمیشن‌ها */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateX(100%);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* بارگذاری */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- مدیریت دسترسی -->
    <div class="access-denied" id="accessDenied">
        <div style="text-align: center; max-width: 500px;">
            <div style="font-size: 80px; color: var(--danger); margin-bottom: 20px;">
                <i class="fas fa-lock"></i>
            </div>
            <h2 style="color: #333; margin-bottom: 15px;">دسترسی غیرمجاز</h2>
            <p style="color: var(--gray); margin-bottom: 30px; line-height: 1.6;">
                شما دسترسی لازم برای مشاهده این صفحه را ندارید. لطفاً ابتدا وارد حساب مدیریتی خود شوید.
            </p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="redirectToLogin()" style="
                    background: var(--primary);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                ">
                    <i class="fas fa-sign-in-alt"></i>
                    ورود به پنل مدیریت
                </button>
                <button onclick="redirectToHome()" style="
                    background: #666;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                ">
                    بازگشت به سایت
                </button>
            </div>
        </div>
    </div>

    <!-- صفحه اصلی پنل -->
    <div class="admin-container" id="adminContainer">
        <!-- هدر -->
        <div class="admin-header">
            <h1>
                <i class="fas fa-crown"></i>
                پنل مدیریت Took Gallery
                <span style="font-size: 14px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; margin-right: 10px;">
                    ADMIN
                </span>
            </h1>
            
            <div class="admin-stats">
                <div class="stat-box">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">سفارشات</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="totalTickets">0</div>
                    <div class="stat-label">تیکت‌ها</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="pendingTickets">0</div>
                    <div class="stat-label">تیکت جدید</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="totalRevenue">0</div>
                    <div class="stat-label">درآمد</div>
                </div>
            </div>
        </div>
        
        <!-- دکمه‌های عملیات -->
        <div class="admin-actions">
            <button class="action-btn refresh-btn" onclick="loadAllData()">
                <i class="fas fa-sync-alt"></i>
                بروزرسانی داده‌ها
            </button>
            
            <button class="action-btn test-btn" onclick="createTestData()">
                <i class="fas fa-plus"></i>
                ایجاد داده تستی
            </button>
            
            <button class="action-btn logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                خروج از پنل
            </button>
        </div>
        
        <!-- تب‌ها -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('orders')">
                    <i class="fas fa-shopping-cart"></i>
                    سفارشات
                </button>
                <button class="tab-btn" onclick="switchTab('tickets')">
                    <i class="fas fa-comments"></i>
                    تیکت‌های پشتیبانی
                </button>
                <button class="tab-btn" onclick="switchTab('products')">
                    <i class="fas fa-box"></i>
                    مدیریت محصولات
                </button>
                <button class="tab-btn" onclick="switchTab('analytics')">
                    <i class="fas fa-chart-line"></i>
                    آمار و گزارشات
                </button>
            </div>
            
            <!-- تب سفارشات -->
            <div class="tab-content active" id="ordersTab">
                <h3 style="color: var(--dark); margin-bottom: 25px; font-size: 22px;">
                    <i class="fas fa-clipboard-list"></i>
                    مدیریت سفارشات
                </h3>
                <div id="ordersContainer">
                    <!-- سفارشات اینجا لود می‌شوند -->
                </div>
            </div>
            
            <!-- تب تیکت‌ها -->
            <div class="tab-content" id="ticketsTab">
                <h3 style="color: var(--dark); margin-bottom: 25px; font-size: 22px;">
                    <i class="fas fa-headset"></i>
                    تیکت‌های پشتیبانی
                </h3>
                <div id="ticketsContainer">
                    <!-- تیکت‌ها اینجا لود می‌شوند -->
                </div>
            </div>
            
            <!-- تب مدیریت محصولات -->
            <div class="tab-content" id="productsTab">
                <h3 style="color: var(--dark); margin-bottom: 25px; font-size: 22px;">
                    <i class="fas fa-boxes"></i>
                    مدیریت محصولات
                </h3>
                <div id="productsContainer">
                    <!-- مدیریت محصولات -->
                </div>
            </div>
            
            <!-- تب آمار و گزارشات -->
            <div class="tab-content" id="analyticsTab">
                <h3 style="color: var(--dark); margin-bottom: 25px; font-size: 22px;">
                    <i class="fas fa-chart-pie"></i>
                    آمار و گزارشات
                </h3>
                <div id="analyticsContainer">
                    <!-- آمار و گزارشات -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- مودال چت -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-window">
            <!-- محتوای چت -->
        </div>
    </div>

    <!-- اعلان -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText"></span>
    </div>

    <!-- بارگذاری -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="color: var(--primary); font-weight: 600;">در حال بارگذاری...</p>
    </div>

    <script>
        // ==================== متغیرهای اصلی ====================
        let currentTab = 'orders';
        let tickets = [];
        let orders = [];
        let currentUser = null;
        let isAdmin = false;
        
        // ==================== اعتبارسنجی دسترسی ====================
        function validateAdminAccess() {
            showLoading(true);
            
            // در پروژه واقعی، این قسمت باید با سرور چک شود
            // برای نمونه، از localStorage استفاده می‌کنیم
            
            const adminData = JSON.parse(localStorage.getItem('adminData'));
            
            // حالت تست: اگر لاگین نبودیم، به صورت خودکار لاگین می‌کنیم
            if (!adminData) {
                console.log('داده‌های مدیریتی یافت نشد. ایجاد حالت تست...');
                
                // ایجاد داده‌های تستی
                const testAdminData = {
                    id: 1,
                    username: 'admin',
                    name: 'مدیر سیستم',
                    role: 'admin',
                    loggedIn: true,
                    sessionId: 'test-session-' + Date.now(),
                    expire: Date.now() + (24 * 60 * 60 * 1000), // 24 ساعت
                    permissions: ['orders', 'tickets', 'products', 'analytics']
                };
                
                localStorage.setItem('adminData', JSON.stringify(testAdminData));
                currentUser = testAdminData;
                isAdmin = true;
                
                console.log('حالت تست فعال شد');
            } else {
                currentUser = adminData;
                isAdmin = adminData.role === 'admin' || adminData.role === 'super_admin';
                
                // بررسی تاریخ انقضا
                if (adminData.expire && Date.now() > adminData.expire) {
                    console.warn('نشست منقضی شده است');
                    logout();
                    return;
                }
            }
            
            // نمایش یا مخفی کردن پنل
            if (isAdmin) {
                document.getElementById('accessDenied').classList.remove('active');
                document.getElementById('adminContainer').classList.add('active');
                showNotification('خوش آمدید مدیر گرامی!', 'success');
                loadAllData();
            } else {
                document.getElementById('accessDenied').classList.add('active');
                document.getElementById('adminContainer').classList.remove('active');
            }
            
            showLoading(false);
        }
        
        // ==================== بارگذاری داده‌ها ====================
        function loadAllData() {
            showLoading(true);
            
            // بارگذاری سفارشات
            loadOrders();
            
            // بارگذاری تیکت‌ها
            loadTickets();
            
            // بارگذاری آمار
            loadAnalytics();
            
            setTimeout(() => {
                showLoading(false);
                showNotification('داده‌ها با موفقیت بروزرسانی شدند', 'success');
            }, 500);
        }
        
        // ==================== بارگذاری سفارشات ====================
        function loadOrders() {
            try {
                const ordersData = localStorage.getItem('orders');
                orders = ordersData ? JSON.parse(ordersData) : [];
                
                // به‌روزرسانی آمار
                document.getElementById('totalOrders').textContent = orders.length;
                
                // محاسبه درآمد کل
                const totalRevenue = orders.reduce((sum, order) => {
                    if (order.total && typeof order.total === 'number') {
                        return sum + order.total;
                    }
                    return sum;
                }, 0);
                
                document.getElementById('totalRevenue').textContent = 
                    totalRevenue.toLocaleString('fa-IR') + ' تومان';
                
                // نمایش سفارشات
                const container = document.getElementById('ordersContainer');
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px;">
                            <i class="fas fa-shopping-cart" style="font-size: 70px; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #333; margin-bottom: 15px;">هنوز سفارشی ثبت نشده</h3>
                            <p style="color: var(--gray); margin-bottom: 25px; max-width: 500px; margin: 0 auto 25px;">
                                پس از ثبت سفارش توسط کاربران، لیست سفارشات در این قسمت نمایش داده خواهد شد.
                            </p>
                            <button onclick="createTestOrder()" style="
                                background: var(--primary);
                                color: white;
                                border: none;
                                padding: 14px 30px;
                                border-radius: 10px;
                                cursor: pointer;
                                font-size: 16px;
                                display: inline-flex;
                                align-items: center;
                                gap: 10px;
                                margin: 10px;
                            ">
                                <i class="fas fa-plus"></i>
                                ایجاد سفارش تستی
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // ایجاد جدول سفارشات
                let tableHTML = `
                    <div style="margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 14px; color: var(--gray);">
                            <i class="fas fa-info-circle"></i>
                            تعداد سفارشات: ${orders.length}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <select id="orderFilter" onchange="filterOrders()" style="
                                padding: 10px 15px;
                                border: 2px solid var(--border);
                                border-radius: 8px;
                                background: white;
                                color: var(--dark);
                                font-size: 14px;
                            ">
                                <option value="all">همه سفارشات</option>
                                <option value="pending">در انتظار پرداخت</option>
                                <option value="paid">پرداخت شده</option>
                                <option value="shipping">در حال ارسال</option>
                                <option value="delivered">تحویل داده شده</option>
                                <option value="cancelled">لغو شده</option>
                            </select>
                            <button onclick="exportOrders()" style="
                                background: var(--success);
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-download"></i>
                                خروجی
                            </button>
                        </div>
                    </div>
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>ردیف</th>
                                <th>کد رهگیری</th>
                                <th>مشتری</th>
                                <th>محصولات</th>
                                <th>مبلغ</th>
                                <th>وضعیت</th>
                                <th>تاریخ</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // مرتب‌سازی: جدیدترین اول
                orders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // محدودیت نمایش 50 سفارش آخر
                const displayOrders = orders.slice(0, 50);
                
                displayOrders.forEach((order, index) => {
                    // خلاصه محصولات
                    const itemsSummary = order.items && order.items.length > 0
                        ? order.items.map(item => 
                            `${item.quantity || 1} عدد ${item.name || 'محصول'}`
                          ).join('<br>')
                        : 'بدون جزئیات';
                    
                    // تعیین وضعیت
                    let statusClass = 'status-pending';
                    let statusText = 'در انتظار پرداخت';
                    
                    if (order.status) {
                        if (order.status.includes('پرداخت') || order.status.includes('paid')) {
                            statusClass = 'status-paid';
                            statusText = 'پرداخت شده';
                        } else if (order.status.includes('ارسال') || order.status.includes('shipping')) {
                            statusClass = 'status-shipping';
                            statusText = 'در حال ارسال';
                        } else if (order.status.includes('تحویل') || order.status.includes('delivered')) {
                            statusClass = 'status-delivered';
                            statusText = 'تحویل داده شده';
                        } else if (order.status.includes('لغو') || order.status.includes('cancelled')) {
                            statusClass = 'status-cancelled';
                            statusText = 'لغو شده';
                        }
                    }
                    
                    // اطلاعات مشتری
                    const customerName = order.customerInfo?.name || 
                                        (order.customerInfo?.firstName + ' ' + order.customerInfo?.lastName) || 
                                        'مهمان';
                    const customerPhone = order.customerInfo?.phone || 'نامشخص';
                    
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <div class="order-id">${order.trackingCode || 'TK-' + order.id}</div>
                                <small style="font-size: 12px; color: var(--gray);">ID: ${order.id}</small>
                            </td>
                            <td>
                                <div class="customer-name">${customerName}</div>
                                <div class="customer-phone">${customerPhone}</div>
                                ${order.customerInfo?.email ? 
                                    `<div style="font-size: 12px; color: var(--gray);">
                                        <i class="fas fa-envelope"></i> ${order.customerInfo.email}
                                    </div>` : ''
                                }
                            </td>
                            <td>${itemsSummary}</td>
                            <td style="color: var(--primary); font-weight: bold; font-size: 16px;">
                                ${order.total ? 
                                    (typeof order.total === 'number' ? 
                                        order.total.toLocaleString('fa-IR') + ' تومان' : 
                                        order.total) : 
                                    'نامشخص'}
                            </td>
                            <td>
                                <span class="status-badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>${order.date || new Date(order.timestamp || Date.now()).toLocaleDateString('fa-IR')}</td>
                            <td>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="viewOrderDetails(${order.id})" style="
                                        background: var(--info);
                                        color: white;
                                        border: none;
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 5px;
                                    ">
                                        <i class="fas fa-eye"></i>
                                        مشاهده
                                    </button>
                                    <select onchange="updateOrderStatus(${order.id}, this.value)" style="
                                        padding: 8px 12px;
                                        border: 1px solid var(--border);
                                        border-radius: 6px;
                                        background: white;
                                        font-size: 12px;
                                        cursor: pointer;
                                    ">
                                        <option value="pending" ${statusText === 'در انتظار پرداخت' ? 'selected' : ''}>در انتظار</option>
                                        <option value="paid" ${statusText === 'پرداخت شده' ? 'selected' : ''}>پرداخت شده</option>
                                        <option value="shipping" ${statusText === 'در حال ارسال' ? 'selected' : ''}>در حال ارسال</option>
                                        <option value="delivered" ${statusText === 'تحویل داده شده' ? 'selected' : ''}>تحویل شده</option>
                                        <option value="cancelled" ${statusText === 'لغو شده' ? 'selected' : ''}>لغو</option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                
                // اطلاعات اضافی
                tableHTML += `
                    <div style="margin-top: 25px; padding: 20px; background: white; border-radius: 12px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div style="color: var(--gray); font-size: 14px;">
                                <i class="fas fa-database"></i>
                                تعداد کل سفارشات در سیستم: ${orders.length}
                            </div>
                            <div style="color: var(--success); font-weight: 600; font-size: 16px;">
                                <i class="fas fa-chart-line"></i>
                                مجموع درآمد: ${totalRevenue.toLocaleString('fa-IR')} تومان
                            </div>
                            <button onclick="clearAllOrders()" style="
                                background: var(--danger);
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <i class="fas fa-trash"></i>
                                پاک کردن همه سفارشات
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = tableHTML;
                
            } catch (error) {
                console.error('خطا در بارگذاری سفارشات:', error);
                showNotification('خطا در بارگذاری سفارشات', 'error');
            }
        }
        
        // ==================== بارگذاری تیکت‌ها ====================
        function loadTickets() {
            try {
                const ticketsData = localStorage.getItem('supportTickets');
                tickets = ticketsData ? JSON.parse(ticketsData) : [];
                
                // به‌روزرسانی آمار
                const pendingTickets = tickets.filter(t => t.status === 'new').length;
                document.getElementById('totalTickets').textContent = tickets.length;
                document.getElementById('pendingTickets').textContent = pendingTickets;
                
                // نمایش تیکت‌ها
                const container = document.getElementById('ticketsContainer');
                
                if (tickets.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px;">
                            <i class="fas fa-comments" style="font-size: 70px; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #333; margin-bottom: 15px;">تیکتی برای نمایش وجود ندارد</h3>
                            <p style="color: var(--gray); margin-bottom: 25px; max-width: 500px; margin: 0 auto 25px;">
                                پس از ارسال تیکت توسط کاربران، لیست تیکت‌ها در این قسمت نمایش داده خواهد شد.
                            </p>
                            <button onclick="createTestTicket()" style="
                                background: var(--primary);
                                color: white;
                                border: none;
                                padding: 14px 30px;
                                border-radius: 10px;
                                cursor: pointer;
                                font-size: 16px;
                                display: inline-flex;
                                align-items: center;
                                gap: 10px;
                            ">
                                <i class="fas fa-plus"></i>
                                ایجاد تیکت تستی
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // ایجاد کارت‌های تیکت
                let ticketsHTML = `
                    <div style="margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 14px; color: var(--gray);">
                            <i class="fas fa-info-circle"></i>
                            ${pendingTickets} تیکت جدید از ${tickets.length} تیکت
                        </div>
                        <select id="ticketFilter" onchange="filterTickets()" style="
                            padding: 10px 15px;
                            border: 2px solid var(--border);
                            border-radius: 8px;
                            background: white;
                            color: var(--dark);
                            font-size: 14px;
                        ">
                            <option value="all">همه تیکت‌ها</option>
                            <option value="new">جدید</option>
                            <option value="pending">در حال بررسی</option>
                            <option value="answered">پاسخ داده</option>
                            <option value="closed">بسته شده</option>
                        </select>
                    </div>
                    <div class="tickets-grid">
                `;
                
                // مرتب‌سازی: تیکت‌های جدید اول
                tickets.sort((a, b) => {
                    if (a.status === 'new' && b.status !== 'new') return -1;
                    if (a.status !== 'new' && b.status === 'new') return 1;
                    return new Date(b.date || b.timestamp) - new Date(a.date || a.timestamp);
                });
                
                tickets.forEach(ticket => {
                    let statusColor = '#ff3b8d';
                    let statusText = 'جدید';
                    
                    if (ticket.status === 'answered') {
                        statusColor = '#4CAF50';
                        statusText = 'پاسخ داده';
                    } else if (ticket.status === 'pending') {
                        statusColor = '#FF9800';
                        statusText = 'در حال بررسی';
                    } else if (ticket.status === 'closed') {
                        statusColor = '#666';
                        statusText = 'بسته شده';
                    }
                    
                    const messagePreview = ticket.message && ticket.message.length > 120 
                        ? ticket.message.substring(0, 120) + '...' 
                        : ticket.message || 'بدون پیام';
                    
                    ticketsHTML += `
                        <div class="ticket-card" onclick="openChat('${ticket.id}')">
                            <div class="ticket-header">
                                <div class="user-info">
                                    <div class="user-avatar">
                                        ${ticket.userName ? ticket.userName.charAt(0) : '?'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 16px;">${ticket.userName || 'کاربر'}</div>
                                        <div style="font-size: 14px; color: var(--gray);">${ticket.userPhone || 'بدون شماره'}</div>
                                    </div>
                                </div>
                                <span style="
                                    background: ${statusColor}15;
                                    color: ${statusColor};
                                    padding: 6px 15px;
                                    border-radius: 20px;
                                    font-size: 13px;
                                    font-weight: 600;
                                    border: 1px solid ${statusColor}30;
                                ">
                                    ${statusText}
                                </span>
                            </div>
                            
                            <div class="ticket-preview">
                                ${messagePreview}
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                                <div style="font-size: 14px; color: var(--gray);">
                                    <i class="far fa-clock"></i> ${ticket.date || 'تاریخ نامشخص'}
                                </div>
                                <button onclick="event.stopPropagation(); closeTicket('${ticket.id}')" style="
                                    background: none;
                                    border: 1px solid var(--border);
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    font-size: 12px;
                                    color: var(--gray);
                                    cursor: pointer;
                                ">
                                    بستن تیکت
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                ticketsHTML += '</div>';
                container.innerHTML = ticketsHTML;
                
            } catch (error) {
                console.error('خطا در بارگذاری تیکت‌ها:', error);
                showNotification('خطا در بارگذاری تیکت‌ها', 'error');
            }
        }
        
        // ==================== بارگذاری آمار و گزارشات ====================
        function loadAnalytics() {
            try {
                const container = document.getElementById('analyticsContainer');
                
                // محاسبه آمار سفارشات
                const totalOrders = orders.length;
                const completedOrders = orders.filter(o => o.status && 
                    (o.status.includes('تحویل') || o.status.includes('delivered'))).length;
                const pendingOrders = orders.filter(o => o.status && 
                    (o.status.includes('انتظار') || o.status.includes('pending'))).length;
                
                // محاسبه درآمد ماه
                const currentMonth = new Date().getMonth();
                const monthlyOrders = orders.filter(o => {
                    const orderDate = new Date(o.timestamp || Date.now());
                    return orderDate.getMonth() === currentMonth;
                });
                
                const monthlyRevenue = monthlyOrders.reduce((sum, order) => {
                    if (order.total && typeof order.total === 'number') {
                        return sum + order.total;
                    }
                    return sum;
                }, 0);
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: var(--gray);">کل سفارشات</div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--dark);">${totalOrders}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #4CAF50, #8BC34A); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: var(--gray);">سفارشات تکمیل شده</div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--dark);">${completedOrders}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #FF9800, #FFB74D); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: var(--gray);">سفارشات در انتظار</div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--dark);">${pendingOrders}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #2196F3, #64B5F6); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: var(--gray);">درآمد ماه جاری</div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--dark);">${monthlyRevenue.toLocaleString('fa-IR')}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                        <h4 style="color: var(--dark); margin-bottom: 20px; font-size: 18px;">
                            <i class="fas fa-chart-bar"></i>
                            آمار سفارشات ۷ روز اخیر
                        </h4>
                        <div style="height: 200px; background: #f8f9fa; border-radius: 10px; display: flex; align-items: flex-end; padding: 20px; gap: 10px;">
                            <!-- نمودار ساده -->
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <div style="width: 100%; background: linear-gradient(to top, var(--primary), var(--primary-light)); border-radius: 5px 5px 0 0; min-height: 20px; transition: height 0.3s; height: ${Math.min(100, Math.random() * 100)}%;"></div>
                                <div style="font-size: 12px; color: var(--gray);">امروز</div>
                            </div>
                            <!-- تکرار برای ۶ روز دیگر -->
                            ${Array.from({length: 6}, (_, i) => `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                    <div style="width: 100%; background: linear-gradient(to top, var(--primary), var(--primary-light)); border-radius: 5px 5px 0 0; min-height: 20px; opacity: ${0.9 - (i * 0.15)}; height: ${Math.min(100, Math.random() * 100)}%;"></div>
                                    <div style="font-size: 12px; color: var(--gray);">${i + 1} روز قبل</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('خطا در بارگذاری آمار:', error);
            }
        }
        
        // ==================== توابع کمکی ====================
        function switchTab(tabName) {
            currentTab = tabName;
            
            // تغییر کلاس تب‌ها
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // بارگذاری داده‌های تب انتخاب شده
            if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'tickets') {
                loadTickets();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const textElement = document.getElementById('notificationText');
            
            notification.className = `notification ${type} active`;
            textElement.textContent = message;
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        function showLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (show) {
                loadingElement.classList.add('active');
            } else {
                setTimeout(() => {
                    loadingElement.classList.remove('active');
                }, 300);
            }
        }
        
        // ==================== توابع سفارشات ====================
        function createTestOrder() {
            const testOrder = {
                id: Date.now(),
                trackingCode: 'TOOK-' + Math.random().toString(36).substr(2, 8).toUpperCase(),
                customerInfo: {
                    name: 'کاربر تستی',
                    phone: '0912' + Math.floor(Math.random() * 10000000).toString().padStart(7, '0'),
                    email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
                    address: 'تهران، خیابان تستی، پلاک ' + Math.floor(Math.random() * 100)
                },
                items: [
                    { name: 'هدفون بی‌سیم', quantity: 1, price: 290000 },
                    { name: 'کفش ورزشی', quantity: 2, price: 350000 },
                    { name: 'شارژر موبایل', quantity: 1, price: 85000 }
                ],
                subtotal: 290000 + (2 * 350000) + 85000,
                shippingCost: 25000,
                discount: 50000,
                total: 290000 + (2 * 350000) + 85000 + 25000 - 50000,
                shippingMethod: 'پست پیشتاز',
                paymentMethod: 'پرداخت آنلاین',
                status: ['در انتظار پرداخت', 'پرداخت شده', 'در حال ارسال', 'تحویل داده شده'][Math.floor(Math.random() * 4)],
                date: new Date().toLocaleDateString('fa-IR'),
                time: new Date().toLocaleTimeString('fa-IR'),
                notes: 'این یک سفارش تستی است',
                timestamp: new Date().getTime()
            };
            
            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(testOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            showNotification(`سفارش تستی ایجاد شد! کد رهگیری: ${testOrder.trackingCode}`);
            loadAllData();
        }
        
        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (!order) {
                showNotification('سفارش پیدا نشد', 'error');
                return;
            }
            
            let detailsHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; margin: 20px auto;">
                    <h3 style="color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 25px;">
                        <i class="fas fa-file-invoice"></i> جزئیات کامل سفارش
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div>
                            <h4 style="color: var(--dark); margin-bottom: 15px; font-size: 16px;">
                                <i class="fas fa-info-circle"></i> اطلاعات سفارش
                            </h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: var(--gray);">شماره سفارش:</span>
                                    <span style="font-weight: bold;">${order.id}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: var(--gray);">کد رهگیری:</span>
                                    <span style="color: var(--primary); font-weight: bold;">${order.trackingCode || 'ندارد'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: var(--gray);">تاریخ ثبت:</span>
                                    <span>${order.date || 'نامشخص'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--gray);">وضعیت:</span>
                                    <span style="font-weight: bold;">${order.status || 'نامشخص'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: var(--dark); margin-bottom: 15px; font-size: 16px;">
                                <i class="fas fa-user"></i> اطلاعات مشتری
                            </h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <div style="margin-bottom: 10px;">
                                    <div style="color: var(--gray); font-size: 14px;">نام:</div>
                                    <div style="font-weight: bold;">${order.customerInfo?.name || 'نامشخص'}</div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <div style="color: var(--gray); font-size: 14px;">تلفن:</div>
                                    <div>${order.customerInfo?.phone || 'نامشخص'}</div>
                                </div>
                                ${order.customerInfo?.email ? `
                                    <div style="margin-bottom: 10px;">
                                        <div style="color: var(--gray); font-size: 14px;">ایمیل:</div>
                                        <div>${order.customerInfo.email}</div>
                                    </div>
                                ` : ''}
                                ${order.customerInfo?.address ? `
                                    <div>
                                        <div style="color: var(--gray); font-size: 14px;">آدرس:</div>
                                        <div>${order.customerInfo.address}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--dark); margin-bottom: 15px; font-size: 16px;">
                        <i class="fas fa-box"></i> محصولات سفارش
                    </h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        ${order.items && order.items.length > 0 ? order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">${item.name}</div>
                                    <div style="font-size: 14px; color: var(--gray);">${item.quantity} عدد × ${item.price.toLocaleString('fa-IR')} تومان</div>
                                </div>
                                <div style="font-weight: bold; color: var(--primary);">
                                    ${(item.quantity * item.price).toLocaleString('fa-IR')} تومان
                                </div>
                            </div>
                        `).join('') : '<div style="text-align: center; padding: 20px; color: var(--gray);">محصولی یافت نشد</div>'}
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                            ${order.subtotal ? `<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>جمع جزء:</span>
                                <span>${order.subtotal.toLocaleString('fa-IR')} تومان</span>
                            </div>` : ''}
                            ${order.shippingCost ? `<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>هزینه ارسال:</span>
                                <span>${order.shippingCost.toLocaleString('fa-IR')} تومان</span>
                            </div>` : ''}
                            ${order.discount ? `<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>تخفیف:</span>
                                <span style="color: var(--success);">-${order.discount.toLocaleString('fa-IR')} تومان</span>
                            </div>` : ''}
                            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: var(--primary); padding-top: 10px; border-top: 1px dashed var(--border);">
                                <span>مبلغ کل:</span>
                                <span>${order.total ? (typeof order.total === 'number' ? order.total.toLocaleString('fa-IR') : order.total) + ' تومان' : 'نامشخص'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: left;">
                        <button onclick="document.getElementById('orderModal').remove()" style="
                            background: #666;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 15px;
                        ">
                            <i class="fas fa-times"></i> بستن
                        </button>
                    </div>
                </div>
            `;
            
            // ایجاد مودال
            const modal = document.createElement('div');
            modal.id = 'orderModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                z-index: 3000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                overflow-y: auto;
            `;
            modal.innerHTML = detailsHTML;
            modal.onclick = function(e) {
                if (e.target === this) this.remove();
            };
            
            document.body.appendChild(modal);
        }
        
        function updateOrderStatus(orderId, newStatus) {
            const order = orders.find(o => o.id == orderId);
            if (!order) {
                showNotification('سفارش پیدا نشد', 'error');
                return;
            }
            
            const statusMap = {
                'pending': 'در انتظار پرداخت',
                'paid': 'پرداخت شده',
                'shipping': 'در حال ارسال',
                'delivered': 'تحویل داده شده',
                'cancelled': 'لغو شده'
            };
            
            order.status = statusMap[newStatus] || newStatus;
            localStorage.setItem('orders', JSON.stringify(orders));
            
            showNotification(`وضعیت سفارش ${order.trackingCode || orderId} به "${order.status}" تغییر یافت`);
            loadOrders();
        }
        
        function clearAllOrders() {
            if (!confirm('آیا مطمئن هستید که می‌خواهید تمام سفارشات را پاک کنید؟ این عمل قابل بازگشت نیست!')) {
                return;
            }
            
            localStorage.removeItem('orders');
            orders = [];
            loadAllData();
            showNotification('تمام سفارشات پاک شدند', 'info');
        }
        
        // ==================== توابع تیکت‌ها ====================
        function createTestTicket() {
            const names = ['علی محمدی', 'فاطمه کریمی', 'محمد حسینی', 'زهرا احمدی', 'رضا موسوی'];
            const messages = [
                'سلام، سفارش من هنوز ارسال نشده. لطفا پیگیری کنید.',
                'محصولی که خریدم مشکل دارد. چگونه می‌توانم مرجوع کنم؟',
                'از دیروز سفارش دادم ولی هنوز تایید نشده.',
                'کد تخفیف کار نمی‌کند. لطفا بررسی کنید.',
                'آیا امکان تغییر آدرس ارسال پس از سفارش وجود دارد؟'
            ];
            
            const testTicket = {
                id: 'ticket-' + Date.now(),
                userName: names[Math.floor(Math.random() * names.length)],
                userPhone: '0912' + Math.floor(Math.random() * 10000000).toString().padStart(7, '0'),
                message: messages[Math.floor(Math.random() * messages.length)],
                status: 'new',
                date: new Date().toLocaleDateString('fa-IR'),
                timestamp: new Date().getTime()
            };
            
            let tickets = JSON.parse(localStorage.getItem('supportTickets')) || [];
            tickets.push(testTicket);
            localStorage.setItem('supportTickets', JSON.stringify(tickets));
            
            showNotification('تیکت تستی ایجاد شد');
            loadTickets();
        }
        
        function openChat(ticketId) {
            // پیاده‌سازی چت
            showNotification('قابلیت چت پیاده‌سازی نشده است', 'warning');
        }
        
        function closeTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            ticket.status = 'closed';
            localStorage.setItem('supportTickets', JSON.stringify(tickets));
            
            showNotification('تیکت بسته شد');
            loadTickets();
        }
        
        // ==================== مدیریت داده‌های تست ====================
        function createTestData() {
            if (!confirm('ایجاد ۵ سفارش و ۳ تیکت تستی؟')) {
                return;
            }
            
            // ایجاد سفارشات تستی
            for (let i = 0; i < 5; i++) {
                createTestOrder();
            }
            
            // ایجاد تیکت‌های تستی
            for (let i = 0; i < 3; i++) {
                createTestTicket();
            }
            
            setTimeout(() => {
                showNotification('داده‌های تستی ایجاد شدند', 'success');
                loadAllData();
            }, 1000);
        }
        
        // ==================== توابع ناوبری ====================
        function redirectToLogin() {
            window.location.href = 'admin-login.html';
        }
        
        function redirectToHome() {
            window.location.href = 'index.html';
        }
        
        function logout() {
            if (!confirm('آیا می‌خواهید از پنل مدیریت خارج شوید؟')) {
                return;
            }
            
            localStorage.removeItem('adminData');
            showNotification('با موفقیت خارج شدید', 'info');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
        
        // ==================== بارگذاری اولیه ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('پنل مدیریت بارگذاری شد');
            validateAdminAccess();
            
            // بارگذاری خودکار هر 30 ثانیه
            setInterval(() => {
                if (currentTab === 'orders') loadOrders();
                if (currentTab === 'tickets') loadTickets();
            }, 30000);
            
            // بستن مودال‌ها با ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.chat-modal.active, #orderModal');
                    modals.forEach(modal => modal.remove());
                }
            });
        });
    </script>
</body>
</html>
